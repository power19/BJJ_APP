{% extends "base.html" %}

{% block title %}Settings{% endblock %}
{% block nav_title %}Settings{% endblock %}

{% block content %}
<div class="page-container">
    <!-- App Branding -->
    <section class="settings-section">
        <div class="section-header">
            <h2>App Branding</h2>
            <p class="section-desc">Customize your gym's appearance</p>
        </div>

        <div class="card">
            <div class="logo-upload">
                <div class="logo-preview" id="logoPreview">
                    {% if logo_exists %}
                    <img src="/static/images/logo.png?v={{ cache_bust }}" alt="Logo" id="currentLogo">
                    {% else %}
                    <div class="logo-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                        </svg>
                        <span>No logo</span>
                    </div>
                    {% endif %}
                </div>
                <div class="logo-actions">
                    <label class="btn btn-secondary btn-sm" for="logoInput">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 011.06 0l4.5 4.5a.75.75 0 01-1.06 1.06l-3.22-3.22V16.5a.75.75 0 01-1.5 0V4.81L8.03 8.03a.75.75 0 01-1.06-1.06l4.5-4.5z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M1.5 15a.75.75 0 01.75.75v2.25c0 .414.336.75.75.75h18a.75.75 0 00.75-.75v-2.25a.75.75 0 011.5 0v2.25A2.25 2.25 0 0121 20.25H3a2.25 2.25 0 01-2.25-2.25v-2.25A.75.75 0 011.5 15z" clip-rule="evenodd" />
                        </svg>
                        Upload Logo
                    </label>
                    <input type="file" id="logoInput" accept="image/*" hidden>
                    {% if logo_exists %}
                    <button type="button" class="btn btn-danger btn-sm" id="removeLogo">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 013.878.512.75.75 0 11-.256 1.478l-.209-.035-1.005 13.07a3 3 0 01-2.991 2.77H8.084a3 3 0 01-2.991-2.77L4.087 6.66l-.209.035a.75.75 0 01-.256-1.478A48.567 48.567 0 017.5 4.705v-.227c0-1.564 1.213-2.9 2.816-2.951a52.662 52.662 0 013.369 0c1.603.051 2.815 1.387 2.815 2.951zm-6.136-1.452a51.196 51.196 0 013.273 0C14.39 3.05 15 3.684 15 4.478v.113a49.488 49.488 0 00-6 0v-.113c0-.794.609-1.428 1.364-1.452zm-.355 5.945a.75.75 0 10-1.5.058l.347 9a.75.75 0 101.499-.058l-.346-9zm5.48.058a.75.75 0 10-1.498-.058l-.347 9a.75.75 0 001.5.058l.345-9z" clip-rule="evenodd" />
                        </svg>
                        Remove
                    </button>
                    {% endif %}
                </div>
            </div>
            <p class="hint">PNG or JPG, recommended 512x512px</p>
        </div>
    </section>

    <!-- ERPNext Connection -->
    <section class="settings-section">
        <div class="section-header">
            <h2>ERPNext Connection</h2>
            <p class="section-desc">Manage your ERPNext integration</p>
        </div>

        <div class="card">
            <div class="connection-status">
                <div class="status-indicator {{ 'connected' if is_connected else 'disconnected' }}">
                    {% if is_connected %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                    </svg>
                    <span>Connected</span>
                    {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" />
                    </svg>
                    <span>Not Connected</span>
                    {% endif %}
                </div>
                {% if erpnext_url %}
                <p class="connection-url">{{ erpnext_url }}</p>
                {% endif %}
            </div>
            <a href="/setup?edit=true" class="btn btn-secondary btn-block">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.078 2.25c-.917 0-1.699.663-1.85 1.567L9.05 5.057a.75.75 0 01-.563.563l-1.24.178a1.875 1.875 0 00-1.567 1.85v1.566c0 .917.663 1.699 1.567 1.85l1.24.178a.75.75 0 01.563.563l.178 1.24a1.875 1.875 0 001.85 1.567h1.566c.917 0 1.699-.663 1.85-1.567l.178-1.24a.75.75 0 01.563-.563l1.24-.178a1.875 1.875 0 001.567-1.85V8.484c0-.917-.663-1.699-1.567-1.85l-1.24-.178a.75.75 0 01-.563-.563l-.178-1.24a1.875 1.875 0 00-1.85-1.567h-1.566z" clip-rule="evenodd" />
                </svg>
                Configure Connection
            </a>
        </div>
    </section>

    <!-- Backup & Restore -->
    <section class="settings-section">
        <div class="section-header">
            <h2>Backup & Restore</h2>
            <p class="section-desc">Export and import your configuration</p>
        </div>

        <div class="card">
            <div class="backup-grid">
                <a href="/settings/backup/config" class="backup-card" download>
                    <div class="backup-icon blue">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25a.75.75 0 01.75.75v11.69l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V3a.75.75 0 01.75-.75zm-9 13.5a.75.75 0 01.75.75v2.25a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V16.5a.75.75 0 011.5 0v2.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V16.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="backup-content">
                        <span class="backup-title">Download Config</span>
                        <span class="backup-desc">App settings backup</span>
                    </div>
                </a>

                <label class="backup-card" for="restoreInput">
                    <div class="backup-icon green">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                            <path fill-rule="evenodd" d="M12 2.25a.75.75 0 01.75.75v11.69l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V3a.75.75 0 01.75-.75zm-9 13.5a.75.75 0 01.75.75v2.25a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V16.5a.75.75 0 011.5 0v2.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V16.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="backup-content">
                        <span class="backup-title">Restore Config</span>
                        <span class="backup-desc">Import settings file</span>
                    </div>
                    <input type="file" id="restoreInput" accept=".json" hidden>
                </label>
            </div>
        </div>
    </section>

    <!-- ERPNext Data Backup -->
    {% if is_connected %}
    <section class="settings-section">
        <div class="section-header">
            <h2>ERPNext Data Backup</h2>
            <p class="section-desc">Download your gym data from ERPNext</p>
        </div>

        <div class="card">
            <div class="erpnext-backup-info" id="backupInfo">
                <div class="backup-loading">
                    <div class="spinner-small"></div>
                    <span>Checking available data...</span>
                </div>
            </div>

            <button type="button" class="btn btn-primary btn-block" id="downloadErpBackup">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path fill-rule="evenodd" d="M12 2.25a.75.75 0 01.75.75v11.69l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V3a.75.75 0 01.75-.75zm-9 13.5a.75.75 0 01.75.75v2.25a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5V16.5a.75.75 0 011.5 0v2.25a3 3 0 01-3 3H5.25a3 3 0 01-3-3V16.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                </svg>
                <span id="downloadBtnText">Download ERPNext Backup</span>
            </button>
            <p class="hint" style="margin-top: 0.75rem;">Includes: Customers, Members, Invoices, Payments, Memberships</p>
        </div>
    </section>

    <!-- ERPNext Initialization -->
    <section class="settings-section">
        <div class="section-header">
            <h2>Database Setup</h2>
            <p class="section-desc">Initialize required ERPNext doctypes for gym management</p>
        </div>

        <div class="card">
            <div class="init-status" id="initStatus">
                <div class="backup-loading">
                    <div class="spinner-small"></div>
                    <span>Checking database status...</span>
                </div>
            </div>

            <div class="init-actions" id="initActions" style="display: none;">
                <button type="button" class="btn btn-primary btn-block" id="runInitBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 6.75a5.25 5.25 0 016.775-5.025.75.75 0 01.313 1.248l-3.32 3.319c.063.475.276.934.641 1.299.365.365.824.578 1.3.64l3.318-3.319a.75.75 0 011.248.313 5.25 5.25 0 01-5.472 6.756c-1.018-.086-1.87.1-2.309.634L7.344 21.3A3.298 3.298 0 112.7 16.657l8.684-7.151c.533-.44.72-1.291.634-2.309A5.342 5.342 0 0112 6.75zM4.117 19.125a.75.75 0 01.75-.75h.008a.75.75 0 01.75.75v.008a.75.75 0 01-.75.75h-.008a.75.75 0 01-.75-.75v-.008z" clip-rule="evenodd" />
                    </svg>
                    <span id="initBtnText">Initialize Database</span>
                </button>
                <button type="button" class="btn btn-secondary btn-block" id="createBeltRanksBtn" style="margin-top: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.166 2.621v.858c-1.035.148-2.059.33-3.071.543a.75.75 0 00-.584.859 6.753 6.753 0 006.138 5.6 6.73 6.73 0 002.743 1.346A6.707 6.707 0 019.279 15H8.54c-1.036 0-1.875.84-1.875 1.875V19.5h-.75a2.25 2.25 0 00-2.25 2.25c0 .414.336.75.75.75h15a.75.75 0 00.75-.75 2.25 2.25 0 00-2.25-2.25h-.75v-2.625c0-1.036-.84-1.875-1.875-1.875h-.739a6.707 6.707 0 00-1.112-3.173 6.73 6.73 0 002.743-1.347 6.753 6.753 0 006.139-5.6.75.75 0 00-.585-.858 47.077 47.077 0 00-3.07-.543V2.62a.75.75 0 00-.658-.744 49.22 49.22 0 00-6.093-.377c-2.063 0-4.096.128-6.093.377a.75.75 0 00-.657.744zm0 2.629c0 1.196.312 2.32.857 3.294A5.266 5.266 0 013.16 5.337a45.6 45.6 0 012.006-.343v.256zm13.5 0v-.256c.674.1 1.343.214 2.006.343a5.265 5.265 0 01-2.863 3.207 6.72 6.72 0 00.857-3.294z" clip-rule="evenodd" />
                    </svg>
                    <span id="beltRanksBtnText">Create Belt Ranks</span>
                </button>
                <button type="button" class="btn btn-secondary btn-block" id="createDefaultsBtn" style="margin-top: 0.5rem;">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                    </svg>
                    <span id="defaultsBtnText">Create All Default Data</span>
                </button>
            </div>
            <p class="hint" style="margin-top: 0.75rem;">Creates: Belt Ranks (Adult + Kids), Membership Types, Class Types</p>
        </div>
    </section>
    {% endif %}

    <!-- App Info -->
    <section class="settings-section">
        <div class="section-header">
            <h2>About</h2>
        </div>

        <div class="card">
            <div class="app-info">
                <div class="info-row">
                    <span class="info-label">App Version</span>
                    <span class="info-value">v1.0.0</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Framework</span>
                    <span class="info-value">FastAPI + Jinja2</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Python</span>
                    <span class="info-value">3.10+</span>
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Status Toast -->
<div class="toast" id="toast">
    <span class="toast-icon" id="toastIcon"></span>
    <span id="toastText"></span>
</div>
{% endblock %}

{% block styles %}
<style>
    .settings-section {
        margin-bottom: 2rem;
    }

    .section-header {
        margin-bottom: 1rem;
    }

    .section-header h2 {
        font-size: 1.125rem;
        font-weight: 600;
        color: #f8fafc;
        margin-bottom: 0.25rem;
    }

    .section-desc {
        font-size: 0.875rem;
        color: #64748b;
    }

    /* Logo Upload */
    .logo-upload {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        margin-bottom: 0.75rem;
    }

    .logo-preview {
        width: 80px;
        height: 80px;
        border-radius: 16px;
        overflow: hidden;
        background: rgba(51, 65, 85, 0.5);
        flex-shrink: 0;
    }

    .logo-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .logo-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: #64748b;
    }

    .logo-placeholder svg {
        width: 32px;
        height: 32px;
        margin-bottom: 0.25rem;
    }

    .logo-placeholder span {
        font-size: 0.6875rem;
    }

    .logo-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .hint {
        font-size: 0.8125rem;
        color: #64748b;
    }

    /* Connection Status */
    .connection-status {
        margin-bottom: 1rem;
    }

    .status-indicator {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.375rem 0.75rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .status-indicator svg {
        width: 18px;
        height: 18px;
    }

    .status-indicator.connected {
        background: rgba(16, 185, 129, 0.15);
        color: #34d399;
    }

    .status-indicator.disconnected {
        background: rgba(239, 68, 68, 0.15);
        color: #f87171;
    }

    .connection-url {
        font-size: 0.8125rem;
        color: #64748b;
        margin-top: 0.5rem;
        word-break: break-all;
    }

    /* Backup Grid */
    .backup-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
    }

    .backup-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: rgba(15, 23, 42, 0.5);
        border: 1px solid rgba(71, 85, 105, 0.3);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        color: inherit;
    }

    .backup-card:hover {
        background: rgba(51, 65, 85, 0.4);
        border-color: rgba(71, 85, 105, 0.5);
    }

    .backup-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .backup-icon svg {
        width: 20px;
        height: 20px;
        color: white;
    }

    .backup-icon.blue {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .backup-icon.green {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .backup-content {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .backup-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #f8fafc;
    }

    .backup-desc {
        font-size: 0.75rem;
        color: #64748b;
    }

    /* App Info */
    .app-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-label {
        font-size: 0.875rem;
        color: #94a3b8;
    }

    .info-value {
        font-size: 0.875rem;
        font-weight: 500;
        color: #e2e8f0;
    }

    /* Button Variants */
    .btn-sm {
        padding: 0.5rem 0.875rem;
        font-size: 0.8125rem;
        min-height: auto;
    }

    .btn-sm svg {
        width: 16px;
        height: 16px;
    }

    .btn-danger {
        background: rgba(239, 68, 68, 0.15);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #f87171;
    }

    .btn-danger:hover {
        background: rgba(239, 68, 68, 0.25);
    }

    .btn-block {
        width: 100%;
    }

    /* Toast */
    .toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(71, 85, 105, 0.5);
        border-radius: 12px;
        padding: 0.875rem 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        font-size: 0.9375rem;
        color: #f8fafc;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
    }

    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .toast.success {
        border-color: rgba(16, 185, 129, 0.5);
    }

    .toast.error {
        border-color: rgba(239, 68, 68, 0.5);
    }

    .toast-icon svg {
        width: 20px;
        height: 20px;
    }

    .toast.success .toast-icon {
        color: #34d399;
    }

    .toast.error .toast-icon {
        color: #f87171;
    }

    /* ERPNext Backup */
    .erpnext-backup-info {
        margin-bottom: 1rem;
    }

    .backup-loading {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #94a3b8;
        font-size: 0.875rem;
    }

    .spinner-small {
        width: 18px;
        height: 18px;
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .backup-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }

    .backup-stat {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        background: rgba(15, 23, 42, 0.4);
        border-radius: 8px;
        font-size: 0.8125rem;
    }

    .backup-stat-label {
        color: #94a3b8;
    }

    .backup-stat-value {
        color: #f8fafc;
        font-weight: 600;
    }

    .backup-stat-value.unavailable {
        color: #64748b;
    }

    /* Initialization Status */
    .init-status {
        margin-bottom: 1rem;
    }

    .init-complete {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: rgba(16, 185, 129, 0.15);
        border: 1px solid rgba(16, 185, 129, 0.3);
        border-radius: 10px;
        color: #34d399;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .init-complete svg {
        width: 20px;
        height: 20px;
    }

    .init-pending {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: rgba(251, 191, 36, 0.15);
        border: 1px solid rgba(251, 191, 36, 0.3);
        border-radius: 10px;
        color: #fbbf24;
        font-size: 0.875rem;
        font-weight: 500;
        margin-bottom: 1rem;
    }

    .init-pending svg {
        width: 20px;
        height: 20px;
    }

    .doctype-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .doctype-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0.75rem;
        background: rgba(15, 23, 42, 0.4);
        border-radius: 8px;
        font-size: 0.8125rem;
    }

    .doctype-name {
        color: #e2e8f0;
    }

    .doctype-status {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .doctype-status svg {
        width: 16px;
        height: 16px;
    }

    .doctype-status.exists {
        color: #34d399;
    }

    .doctype-status.missing {
        color: #f87171;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const toast = document.getElementById('toast');
    const toastIcon = document.getElementById('toastIcon');
    const toastText = document.getElementById('toastText');

    function showToast(type, message) {
        toast.className = 'toast show ' + type;
        toastIcon.innerHTML = type === 'success'
            ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>'
            : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" /></svg>';
        toastText.textContent = message;

        setTimeout(() => {
            toast.className = 'toast';
        }, 3000);
    }

    // Logo Upload
    document.getElementById('logoInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('logo', file);

        try {
            const response = await fetch('/settings/upload-logo', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                showToast('success', 'Logo uploaded successfully');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('error', result.error || 'Upload failed');
            }
        } catch (error) {
            showToast('error', 'Upload failed');
        }
    });

    // Remove Logo
    const removeLogo = document.getElementById('removeLogo');
    if (removeLogo) {
        removeLogo.addEventListener('click', async () => {
            if (!confirm('Remove the logo?')) return;

            try {
                const response = await fetch('/settings/remove-logo', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    showToast('success', 'Logo removed');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('error', result.error || 'Failed to remove logo');
                }
            } catch (error) {
                showToast('error', 'Failed to remove logo');
            }
        });
    }

    // Restore Config
    document.getElementById('restoreInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('config', file);

        try {
            const response = await fetch('/settings/restore-config', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();

            if (result.success) {
                showToast('success', 'Config restored successfully');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('error', result.error || 'Restore failed');
            }
        } catch (error) {
            showToast('error', 'Restore failed');
        }
    });

    // ERPNext Backup
    const backupInfo = document.getElementById('backupInfo');
    const downloadErpBtn = document.getElementById('downloadErpBackup');
    const downloadBtnText = document.getElementById('downloadBtnText');

    if (backupInfo && downloadErpBtn) {
        // Load backup status
        async function loadBackupStatus() {
            try {
                const response = await fetch('/settings/backup/erpnext/status');
                const result = await response.json();

                if (result.success) {
                    let html = '<div class="backup-stats">';
                    for (const [doctype, count] of Object.entries(result.counts)) {
                        const displayName = doctype.replace('_', ' ');
                        const countText = count >= 0 ? count : 'N/A';
                        const countClass = count >= 0 ? '' : 'unavailable';
                        html += `
                            <div class="backup-stat">
                                <span class="backup-stat-label">${displayName}</span>
                                <span class="backup-stat-value ${countClass}">${countText}</span>
                            </div>
                        `;
                    }
                    html += '</div>';
                    backupInfo.innerHTML = html;
                } else {
                    backupInfo.innerHTML = '<p class="hint">Could not load backup status</p>';
                }
            } catch (error) {
                backupInfo.innerHTML = '<p class="hint">Could not load backup status</p>';
            }
        }

        loadBackupStatus();

        // Download ERPNext backup
        downloadErpBtn.addEventListener('click', async () => {
            downloadErpBtn.disabled = true;
            downloadBtnText.textContent = 'Downloading...';

            try {
                const response = await fetch('/settings/backup/erpnext');

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `erpnext_backup_${new Date().toISOString().slice(0,10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    showToast('success', 'Backup downloaded successfully');
                } else {
                    const result = await response.json();
                    showToast('error', result.error || 'Download failed');
                }
            } catch (error) {
                showToast('error', 'Download failed');
            }

            downloadErpBtn.disabled = false;
            downloadBtnText.textContent = 'Download ERPNext Backup';
        });
    }

    // Database Initialization
    const initStatus = document.getElementById('initStatus');
    const initActions = document.getElementById('initActions');
    const runInitBtn = document.getElementById('runInitBtn');
    const createBeltRanksBtn = document.getElementById('createBeltRanksBtn');
    const createDefaultsBtn = document.getElementById('createDefaultsBtn');
    const initBtnText = document.getElementById('initBtnText');
    const beltRanksBtnText = document.getElementById('beltRanksBtnText');
    const defaultsBtnText = document.getElementById('defaultsBtnText');

    if (initStatus) {
        // Load initialization status
        async function loadInitStatus() {
            try {
                const response = await fetch('/settings/init/status');
                const result = await response.json();

                if (result.success) {
                    if (result.is_complete) {
                        initStatus.innerHTML = `
                            <div class="init-complete">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" />
                                </svg>
                                <span>All doctypes initialized</span>
                            </div>
                        `;
                        // Show only the create defaults button
                        initActions.style.display = 'block';
                        runInitBtn.style.display = 'none';
                    } else {
                        // Show doctype status list
                        let html = `
                            <div class="init-pending">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9.401 3.003c1.155-2 4.043-2 5.197 0l7.355 12.748c1.154 2-.29 4.5-2.599 4.5H4.645c-2.309 0-3.752-2.5-2.598-4.5L9.4 3.003zM12 8.25a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V9a.75.75 0 01.75-.75zm0 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" />
                                </svg>
                                <span>Some doctypes need initialization</span>
                            </div>
                            <div class="doctype-list">
                        `;

                        for (const [doctype, exists] of Object.entries(result.doctypes)) {
                            const statusClass = exists ? 'exists' : 'missing';
                            const statusIcon = exists
                                ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>'
                                : '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" /></svg>';
                            const statusText = exists ? 'Ready' : 'Missing';

                            html += `
                                <div class="doctype-item">
                                    <span class="doctype-name">${doctype}</span>
                                    <span class="doctype-status ${statusClass}">${statusIcon} ${statusText}</span>
                                </div>
                            `;
                        }

                        html += '</div>';
                        initStatus.innerHTML = html;
                        initActions.style.display = 'block';
                        runInitBtn.style.display = 'flex';
                    }
                } else {
                    initStatus.innerHTML = '<p class="hint">Could not check initialization status</p>';
                }
            } catch (error) {
                initStatus.innerHTML = '<p class="hint">Could not check initialization status</p>';
            }
        }

        loadInitStatus();

        // Run initialization
        if (runInitBtn) {
            runInitBtn.addEventListener('click', async () => {
                runInitBtn.disabled = true;
                initBtnText.textContent = 'Initializing...';

                try {
                    const response = await fetch('/settings/init/run', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        showToast('success', 'Database initialized successfully');
                        setTimeout(() => loadInitStatus(), 500);
                    } else {
                        // Show partial results
                        let errorMsg = result.message || 'Initialization failed';
                        if (result.results) {
                            const failed = Object.entries(result.results)
                                .filter(([_, r]) => !r.success)
                                .map(([name, _]) => name);
                            if (failed.length > 0) {
                                errorMsg += ': ' + failed.join(', ');
                            }
                        }
                        showToast('error', errorMsg);
                        loadInitStatus();
                    }
                } catch (error) {
                    showToast('error', 'Initialization failed');
                }

                runInitBtn.disabled = false;
                initBtnText.textContent = 'Initialize Database';
            });
        }

        // Create belt ranks only
        if (createBeltRanksBtn) {
            createBeltRanksBtn.addEventListener('click', async () => {
                createBeltRanksBtn.disabled = true;
                beltRanksBtnText.textContent = 'Creating...';

                try {
                    const response = await fetch('/settings/init/create-belt-ranks', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        showToast('success', result.message || 'Belt ranks created successfully');
                    } else {
                        showToast('error', result.message || 'Failed to create belt ranks');
                    }
                } catch (error) {
                    showToast('error', 'Failed to create belt ranks');
                }

                createBeltRanksBtn.disabled = false;
                beltRanksBtnText.textContent = 'Create Belt Ranks';
            });
        }

        // Create default data
        if (createDefaultsBtn) {
            createDefaultsBtn.addEventListener('click', async () => {
                createDefaultsBtn.disabled = true;
                defaultsBtnText.textContent = 'Creating...';

                try {
                    const response = await fetch('/settings/init/create-defaults', { method: 'POST' });
                    const result = await response.json();

                    if (result.success) {
                        showToast('success', 'All default data created successfully');
                    } else {
                        let errorMsg = result.message || 'Failed to create default data';
                        if (result.results) {
                            const failed = Object.entries(result.results)
                                .filter(([_, r]) => !r.success)
                                .map(([name, r]) => `${name}: ${r.message}`);
                            if (failed.length > 0) {
                                console.log('Failed items:', failed);
                            }
                        }
                        showToast('error', errorMsg);
                    }
                } catch (error) {
                    showToast('error', 'Failed to create default data');
                }

                createDefaultsBtn.disabled = false;
                defaultsBtnText.textContent = 'Create All Default Data';
            });
        }
    }
</script>
{% endblock %}
