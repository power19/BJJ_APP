<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <title>Edit Member - Invictus BJJ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            min-height: 100vh;
            color: #f8fafc;
        }

        .bg-gradient {
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse at 0% 0%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 100% 100%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                #0f172a;
            z-index: -1;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 1rem;
            padding-top: calc(env(safe-area-inset-top, 0px) + 1rem);
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 2rem);
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .back-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            text-decoration: none;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(51, 65, 85, 0.8);
            color: #f1f5f9;
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #f1f5f9;
        }

        .header-content p {
            color: #64748b;
            font-size: 0.875rem;
        }

        /* Form */
        .form-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(71, 85, 105, 0.4);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .form-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #f1f5f9;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-card-title svg {
            color: #3b82f6;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #94a3b8;
            margin-bottom: 0.5rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 10px;
            color: #f1f5f9;
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        input::placeholder, textarea::placeholder {
            color: #64748b;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* RFID Section */
        .rfid-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .rfid-input-group input {
            flex: 1;
        }

        .rfid-scan-btn {
            padding: 0.875rem 1rem;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rfid-status {
            margin-top: 0.5rem;
            font-size: 0.8125rem;
            color: #64748b;
        }

        .rfid-status.available {
            color: #10b981;
        }

        .rfid-status.in-use {
            color: #ef4444;
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-secondary {
            background: rgba(51, 65, 85, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: #f1f5f9;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #1e293b;
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-color: rgba(16, 185, 129, 0.5);
        }

        .toast.error {
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Delete modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #1e293b;
            border: 1px solid rgba(71, 85, 105, 0.5);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .modal h3 {
            color: #ef4444;
            margin-bottom: 0.5rem;
        }

        .modal p {
            color: #94a3b8;
            margin-bottom: 1.5rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
        }

        @media (max-width: 480px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>

    <div class="container">
        <header class="header">
            <a href="/members/{{ member.name }}" class="back-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </a>
            <div class="header-content">
                <h1>Edit Member</h1>
                <p>{{ member.full_name }}</p>
            </div>
        </header>

        <form id="editForm">
            <!-- Personal Information -->
            <div class="form-card">
                <div class="form-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
                    </svg>
                    Personal Information
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="first_name">First Name</label>
                        <input type="text" id="first_name" name="first_name" value="{{ member.first_name or '' }}" required>
                    </div>
                    <div class="form-group">
                        <label for="last_name">Last Name</label>
                        <input type="text" id="last_name" name="last_name" value="{{ member.last_name or '' }}" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">Phone</label>
                        <input type="tel" id="phone" name="phone" value="{{ member.phone or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" value="{{ member.email or '' }}">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="date_of_birth">Date of Birth</label>
                        <input type="date" id="date_of_birth" name="date_of_birth" value="{{ member.date_of_birth or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="gender">Gender</label>
                        <select id="gender" name="gender">
                            <option value="">Select...</option>
                            <option value="Male" {% if member.gender == 'Male' %}selected{% endif %}>Male</option>
                            <option value="Female" {% if member.gender == 'Female' %}selected{% endif %}>Female</option>
                            <option value="Other" {% if member.gender == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">Address</label>
                    <textarea id="address" name="address" placeholder="Full address">{{ member.address or '' }}</textarea>
                </div>
            </div>

            <!-- RFID Tag -->
            <div class="form-card">
                <div class="form-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 3.75a3 3 0 00-3 3v.75h21v-.75a3 3 0 00-3-3h-15z" />
                        <path fill-rule="evenodd" d="M3 11.25h18v6a3 3 0 01-3 3H6a3 3 0 01-3-3v-6zm2.25 3a.75.75 0 01.75-.75h6a.75.75 0 010 1.5H6a.75.75 0 01-.75-.75z" clip-rule="evenodd" />
                    </svg>
                    RFID Tag
                </div>

                <div class="form-group">
                    <label for="rfid_tag">RFID Tag Number</label>
                    <div class="rfid-input-group">
                        <input type="text" id="rfid_tag" name="rfid_tag" value="{{ member.rfid_tag or '' }}" placeholder="Scan or enter RFID tag">
                        <button type="button" class="rfid-scan-btn" id="scanRfidBtn">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M8.5 14.5A2.5 2.5 0 0011 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 11-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 002.5 2.5z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="rfid-status" id="rfidStatus">
                        {% if member.rfid_tag %}Current: {{ member.rfid_tag }}{% else %}No RFID assigned{% endif %}
                    </div>
                </div>
            </div>

            <!-- Emergency Contact -->
            <div class="form-card">
                <div class="form-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path fill-rule="evenodd" d="M1.5 4.5a3 3 0 013-3h1.372c.86 0 1.61.586 1.819 1.42l1.105 4.423a1.875 1.875 0 01-.694 1.955l-1.293.97c-.135.101-.164.249-.126.352a11.285 11.285 0 006.697 6.697c.103.038.25.009.352-.126l.97-1.293a1.875 1.875 0 011.955-.694l4.423 1.105c.834.209 1.42.959 1.42 1.82V19.5a3 3 0 01-3 3h-2.25C8.552 22.5 1.5 15.448 1.5 6.75V4.5z" clip-rule="evenodd" />
                    </svg>
                    Emergency Contact
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="emergency_contact">Contact Name</label>
                        <input type="text" id="emergency_contact" name="emergency_contact" value="{{ member.emergency_contact or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="emergency_phone">Contact Phone</label>
                        <input type="tel" id="emergency_phone" name="emergency_phone" value="{{ member.emergency_phone or '' }}">
                    </div>
                </div>
            </div>

            <!-- Guardian Information (for minors) -->
            {% if member.member_type in ['Child', 'Teenager'] %}
            <div class="form-card">
                <div class="form-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M4.5 6.375a4.125 4.125 0 118.25 0 4.125 4.125 0 01-8.25 0zM14.25 8.625a3.375 3.375 0 116.75 0 3.375 3.375 0 01-6.75 0zM1.5 19.125a7.125 7.125 0 0114.25 0v.003l-.001.119a.75.75 0 01-.363.63 13.067 13.067 0 01-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 01-.364-.63l-.001-.122z" />
                    </svg>
                    Guardian Information
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="guardian_name">Guardian Name</label>
                        <input type="text" id="guardian_name" name="guardian_name" value="{{ member.guardian_name or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="guardian_relationship">Relationship</label>
                        <select id="guardian_relationship" name="guardian_relationship">
                            <option value="">Select...</option>
                            <option value="Parent" {% if member.guardian_relationship == 'Parent' %}selected{% endif %}>Parent</option>
                            <option value="Mother" {% if member.guardian_relationship == 'Mother' %}selected{% endif %}>Mother</option>
                            <option value="Father" {% if member.guardian_relationship == 'Father' %}selected{% endif %}>Father</option>
                            <option value="Guardian" {% if member.guardian_relationship == 'Guardian' %}selected{% endif %}>Guardian</option>
                            <option value="Other" {% if member.guardian_relationship == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="guardian_phone">Guardian Phone</label>
                        <input type="tel" id="guardian_phone" name="guardian_phone" value="{{ member.guardian_phone or '' }}">
                    </div>
                    <div class="form-group">
                        <label for="guardian_email">Guardian Email</label>
                        <input type="email" id="guardian_email" name="guardian_email" value="{{ member.guardian_email or '' }}">
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="btn-group">
                <button type="submit" class="btn btn-primary" id="saveBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                        <polyline points="17,21 17,13 7,13 7,21"/>
                        <polyline points="7,3 7,8 15,8"/>
                    </svg>
                    Save Changes
                </button>
                <button type="button" class="btn btn-danger" id="deleteBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3,6 5,6 21,6"/>
                        <path d="M19,6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3,0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    </svg>
                    Delete
                </button>
            </div>
        </form>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal">
            <h3>Delete Member?</h3>
            <p>This action cannot be undone. All associated data may be lost.</p>
            <div class="modal-buttons">
                <button class="btn btn-secondary" id="cancelDelete">Cancel</button>
                <button class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        const memberId = '{{ member.name }}';
        const form = document.getElementById('editForm');
        const saveBtn = document.getElementById('saveBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const deleteModal = document.getElementById('deleteModal');
        const rfidInput = document.getElementById('rfid_tag');
        const rfidStatus = document.getElementById('rfidStatus');

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = `toast show ${type}`;
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }

        // Save form
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<svg class="spin" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg> Saving...';

            const formData = new FormData(form);
            const data = {};

            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }

            try {
                const response = await fetch(`/members/api/${memberId}/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Member updated successfully');
                    setTimeout(() => {
                        window.location.href = `/members/${memberId}`;
                    }, 1000);
                } else {
                    showToast(result.error || 'Failed to update member', 'error');
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg> Save Changes';
                }
            } catch (error) {
                showToast('Error saving changes', 'error');
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17,21 17,13 7,13 7,21"/><polyline points="7,3 7,8 15,8"/></svg> Save Changes';
            }
        });

        // Delete member
        deleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('show');
        });

        document.getElementById('cancelDelete').addEventListener('click', () => {
            deleteModal.classList.remove('show');
        });

        document.getElementById('confirmDelete').addEventListener('click', async () => {
            const confirmBtn = document.getElementById('confirmDelete');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Deleting...';

            try {
                const response = await fetch(`/members/api/${memberId}/delete`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showToast('Member deleted');
                    setTimeout(() => {
                        window.location.href = '/members';
                    }, 1000);
                } else {
                    showToast(result.error || 'Failed to delete member', 'error');
                    deleteModal.classList.remove('show');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Delete';
                }
            } catch (error) {
                showToast('Error deleting member', 'error');
                deleteModal.classList.remove('show');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Delete';
            }
        });

        // Check RFID availability
        let rfidTimeout;
        rfidInput.addEventListener('input', () => {
            clearTimeout(rfidTimeout);
            const tag = rfidInput.value.trim();

            if (!tag) {
                rfidStatus.textContent = 'No RFID assigned';
                rfidStatus.className = 'rfid-status';
                return;
            }

            rfidStatus.textContent = 'Checking...';
            rfidStatus.className = 'rfid-status';

            rfidTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/members/api/check-rfid/${encodeURIComponent(tag)}`);
                    const result = await response.json();

                    if (result.success) {
                        if (result.in_use && result.used_by !== '{{ member.full_name }}') {
                            rfidStatus.textContent = `In use by: ${result.used_by}`;
                            rfidStatus.className = 'rfid-status in-use';
                        } else {
                            rfidStatus.textContent = 'Available';
                            rfidStatus.className = 'rfid-status available';
                        }
                    }
                } catch (error) {
                    rfidStatus.textContent = 'Could not verify';
                    rfidStatus.className = 'rfid-status';
                }
            }, 500);
        });

        // Close modal on outside click
        deleteModal.addEventListener('click', (e) => {
            if (e.target === deleteModal) {
                deleteModal.classList.remove('show');
            }
        });
    </script>

    <style>
        .spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</body>
</html>
